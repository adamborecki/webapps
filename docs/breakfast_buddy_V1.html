<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Breakfast Buddy ü•û</title>
  <style>
    :root{
      --bg:#0f1220;
      --card:#171a2d;
      --card2:#1d2140;
      --txt:#f5f6ff;
      --muted:#b8bbd6;
      --accent:#7cf7c6;
      --accent2:#ffdf6e;
      --danger:#ff6e6e;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius: 18px;
      --tap: 54px;
      --font: ui-rounded, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      color:var(--txt);
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(124,247,198,.18), transparent 60%),
        radial-gradient(900px 700px at 80% 20%, rgba(255,223,110,.14), transparent 55%),
        radial-gradient(900px 900px at 50% 110%, rgba(255,110,110,.12), transparent 55%),
        var(--bg);
      -webkit-tap-highlight-color: transparent;
      padding: max(10px, env(safe-area-inset-top)) max(10px, env(safe-area-inset-right))
               max(14px, env(safe-area-inset-bottom)) max(10px, env(safe-area-inset-left));
    }

    .wrap{max-width:980px;margin:0 auto;display:flex;flex-direction:column;gap:12px}

    header{
      display:flex;align-items:center;justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      background:rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.08);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(8px);
    }
    .brand{
      display:flex;align-items:center;gap:10px;min-width:0;
    }
    .logo{
      width:42px;height:42px;border-radius:14px;
      background: linear-gradient(135deg, rgba(124,247,198,.35), rgba(255,223,110,.28));
      display:grid;place-items:center;
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 10px 22px rgba(0,0,0,.25);
      flex:0 0 auto;
      font-size:22px;
    }
    .title{
      display:flex;flex-direction:column;gap:2px;min-width:0;
    }
    .title b{font-size:16px;line-height:1.1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .title span{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    .topBtns{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    button{
      border:0;
      background:rgba(255,255,255,.06);
      color:var(--txt);
      padding:10px 12px;
      border-radius:14px;
      min-height:44px;
      font-weight:700;
      letter-spacing:.2px;
      border:1px solid rgba(255,255,255,.12);
      box-shadow: 0 10px 18px rgba(0,0,0,.18);
      cursor:pointer;
      touch-action: manipulation;
    }
    button:active{transform: translateY(1px)}
    button.primary{
      background: linear-gradient(135deg, rgba(124,247,198,.22), rgba(124,247,198,.08));
      border-color: rgba(124,247,198,.35);
    }
    button.warn{
      background: linear-gradient(135deg, rgba(255,110,110,.20), rgba(255,110,110,.08));
      border-color: rgba(255,110,110,.35);
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    @media (min-width: 860px){
      .grid{
        grid-template-columns: 1.15fr .85fr;
        align-items:start;
      }
    }

    .card{
      background:rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.10);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      display:flex;align-items:center;justify-content:space-between;
      gap:10px;
      padding:12px 14px;
      background: rgba(255,255,255,.03);
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .card .hd h2{
      margin:0;
      font-size:14px;
      letter-spacing:.2px;
      color:var(--txt);
    }
    .card .bd{padding:12px 14px}

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .row > *{flex:0 0 auto}

    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
      color:var(--muted);
      font-size:12px;
    }
    .pill b{color:var(--txt)}
    .meter{
      width:100%;
      height:12px;border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    .meter > i{
      display:block;height:100%;
      width:50%;
      background: linear-gradient(90deg, rgba(124,247,198,.8), rgba(255,223,110,.8));
      border-radius:999px;
    }

    /* Kitchen board */
    .kitchen{
      display:flex;flex-direction:column;gap:10px;
    }
    .board{
      display:flex;flex-direction:column;gap:10px;
    }
    .avatarLine{
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
    }
    .avatar{
      display:flex;align-items:center;gap:10px;min-width:0;
    }
    .kid{
      width:56px;height:56px;border-radius:18px;
      display:grid;place-items:center;
      background: linear-gradient(135deg, rgba(124,247,198,.18), rgba(255,223,110,.14));
      border:1px solid rgba(255,255,255,.12);
      font-size:30px;
      box-shadow: 0 12px 24px rgba(0,0,0,.22);
      flex:0 0 auto;
    }
    .kidInfo{min-width:0}
    .kidInfo b{display:block;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .kidInfo span{display:block;font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .smallBtn{
      padding:9px 10px;min-height:44px;font-size:12px;border-radius:14px
    }

    .tray{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:10px;
    }
    @media (min-width: 560px){
      .tray{grid-template-columns: repeat(3, minmax(0,1fr));}
    }

    .slot{
      position:relative;
      padding:10px;
      border-radius:16px;
      background:rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.10);
      min-height:92px;
      display:flex;flex-direction:column;gap:8px;
      overflow:hidden;
    }
    .slot .top{
      display:flex;align-items:center;justify-content:space-between;gap:8px;
    }
    .slot .label{
      font-size:12px;color:var(--muted);font-weight:800;letter-spacing:.2px;
      text-transform:uppercase;
    }
    .slot .emoji{
      font-size:30px;
      line-height:1;
      display:flex;
      align-items:center;
      justify-content:center;
      height:44px;
      border-radius:14px;
      background:rgba(0,0,0,.12);
      border:1px solid rgba(255,255,255,.08);
    }
    .slot .controls{
      display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:space-between;
    }
    .counter{
      display:flex;align-items:center;gap:6px;
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
      border-radius:999px;
      padding:6px 8px;
      font-weight:900;
      font-size:12px;
      min-height:38px;
    }
    .counter button{
      min-height:34px;
      padding:6px 10px;
      border-radius:12px;
      background:rgba(255,255,255,.06);
      box-shadow:none;
      border:1px solid rgba(255,255,255,.10);
      font-weight:900;
    }
    .counter .n{min-width:22px;text-align:center}

    .slot .stamp{
      position:absolute;right:-22px;top:-22px;
      width:84px;height:84px;border-radius:30px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.20), rgba(255,255,255,0));
      transform: rotate(10deg);
      opacity:.55;
      pointer-events:none;
    }

    /* Pantry picker */
    .pantry{
      display:flex;flex-direction:column;gap:10px;
    }
    .pantryGrid{
      display:grid;
      grid-template-columns: repeat(6, minmax(0,1fr));
      gap:8px;
    }
    @media (min-width: 520px){ .pantryGrid{grid-template-columns: repeat(9, minmax(0,1fr));} }
    .chip{
      width:100%;
      min-height:44px;
      border-radius:16px;
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
      display:grid;place-items:center;
      font-size:22px;
      cursor:pointer;
      user-select:none;
      touch-action: manipulation;
    }
    .chip:active{transform: translateY(1px)}
    .chip.selected{
      outline: 2px solid rgba(124,247,198,.55);
      background:rgba(124,247,198,.12);
    }

    /* Mini "ad" strip */
    .adStrip{
      display:flex;align-items:center;gap:10px;justify-content:space-between;
      padding:10px 12px;
      border-radius:16px;
      background:rgba(255,255,255,.035);
      border:1px dashed rgba(255,255,255,.14);
      color:var(--muted);
      font-size:12px;
    }
    .adStrip b{color:var(--txt)}
    .adStrip .cta{
      display:flex;align-items:center;gap:8px;flex:0 0 auto;
    }
    .tinyBtn{
      min-height:40px;
      padding:8px 10px;
      border-radius:14px;
      font-size:12px;
      box-shadow:none;
    }

    /* Modal */
    .backdrop{
      position:fixed;inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding: max(10px, env(safe-area-inset-top)) max(10px, env(safe-area-inset-right))
               max(12px, env(safe-area-inset-bottom)) max(10px, env(safe-area-inset-left));
      z-index:50;
    }
    .backdrop.show{display:flex}
    .modal{
      width:min(920px, 100%);
      border-radius: 24px;
      background: rgba(20,22,40,.98);
      border:1px solid rgba(255,255,255,.12);
      box-shadow: 0 26px 70px rgba(0,0,0,.6);
      overflow:hidden;
      max-height: 86vh;
      display:flex;flex-direction:column;
    }
    .modal .mh{
      padding:12px 14px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
    }
    .modal .mh b{font-size:14px}
    .modal .mh .x{min-height:40px;padding:8px 10px;border-radius:14px}
    .modal .mb{
      padding:12px 14px;
      overflow:auto;
      display:flex;flex-direction:column;gap:12px;
    }

    .seg{
      display:flex;gap:8px;flex-wrap:wrap;
    }
    .seg button{
      min-height:42px;
      padding:8px 10px;
      border-radius:14px;
      font-size:12px;
      box-shadow:none;
    }
    .seg button.on{
      background: rgba(124,247,198,.14);
      border-color: rgba(124,247,198,.40);
    }

    .field{
      display:flex;flex-direction:column;gap:6px;
      background:rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      padding:10px;
    }
    .field label{font-size:12px;color:var(--muted);font-weight:800}
    .field input[type="text"], .field input[type="range"]{
      width:100%;
    }
    input[type="text"]{
      background:rgba(0,0,0,.20);
      border:1px solid rgba(255,255,255,.12);
      color:var(--txt);
      padding:10px 12px;
      border-radius:14px;
      font-size:14px;
      outline:none;
    }
    input[type="range"]{accent-color: var(--accent)}
    .hint{font-size:12px;color:var(--muted)}
    .ok{color: var(--accent)}
    .bad{color: var(--danger)}

    /* Toast */
    .toast{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom: max(14px, env(safe-area-inset-bottom));
      background: rgba(20,22,40,.92);
      border:1px solid rgba(255,255,255,.14);
      padding:10px 12px;
      border-radius:16px;
      box-shadow: 0 18px 50px rgba(0,0,0,.55);
      display:none;
      gap:10px;
      align-items:center;
      z-index:80;
      max-width: min(900px, calc(100% - 24px));
    }
    .toast.show{display:flex}
    .toast .tEmoji{font-size:20px}
    .toast .tTxt{font-size:13px;color:var(--txt)}
    .toast .tTxt b{color:var(--accent2)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">ü•û</div>
        <div class="title">
          <b id="appTitle">Breakfast Buddy</b>
          <span id="subTitle">Build a yummy tray, earn kindness stars ‚ú®</span>
        </div>
      </div>
      <div class="topBtns">
        <button class="primary" id="btnNew">New Tray</button>
        <button id="btnChallenge">Mini Challenge</button>
        <button id="btnCustomize">Customize</button>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT: Main game -->
      <section class="card">
        <div class="hd">
          <h2>üß∫ Your Breakfast Tray</h2>
          <span class="pill"><b id="starsNum">0</b> kindness stars ‚ú®</span>
        </div>
        <div class="bd kitchen">
          <div class="avatarLine">
            <div class="avatar">
              <div class="kid" id="kidEmoji">üßá</div>
              <div class="kidInfo">
                <b id="kidName">Chef</b>
                <span id="kidTag">Small choices ‚Üí big kindness üíõ</span>
              </div>
            </div>
            <div class="row">
              <span class="pill">Difficulty: <b id="diffLabel">Easy</b></span>
              <span class="pill">Timer: <b id="timerLabel">Off</b></span>
            </div>
          </div>

          <div class="board">
            <div class="tray" id="tray"></div>

            <div class="adStrip" id="adStrip">
              <div class="msg">
                <b id="adTitle">Tiny Tip</b> ¬∑ <span id="adText">Try saying ‚Äúplease‚Äù and ‚Äúthank you‚Äù today.</span>
              </div>
              <div class="cta">
                <button class="tinyBtn" id="adBtn">Try</button>
              </div>
            </div>

            <div class="row">
              <div style="flex:1 1 220px;min-width:220px">
                <div class="pill" style="width:100%;justify-content:space-between">
                  <span>Yummy Meter</span>
                  <b id="yummyNum">50</b>
                </div>
                <div class="meter" aria-label="yummy meter">
                  <i id="yummyBar"></i>
                </div>
                <div class="hint" id="yummyHint" style="margin-top:6px">
                  Balance your tray: add a fruit üçìüçåüçäüçá or a drink ü•õüßÉ‚òïÔ∏èü´ñ
                </div>
              </div>
              <button class="primary" id="btnServe" style="flex:0 0 auto">Serve Tray üçΩÔ∏è</button>
            </div>
          </div>
        </div>
      </section>

      <!-- RIGHT: Pantry + Stats -->
      <aside class="card">
        <div class="hd">
          <h2>üçØ Pantry Picker</h2>
          <span class="pill">Tap an emoji ‚Üí pick a slot</span>
        </div>
        <div class="bd pantry">
          <div class="row">
            <span class="pill">Selected slot: <b id="slotLabel">1</b></span>
            <span class="pill">Mode: <b id="modeLabel">Tap-to-Place</b></span>
          </div>

          <div class="pantryGrid" id="pantry"></div>

          <div class="card" style="background:rgba(255,255,255,.03);border-color:rgba(255,255,255,.10)">
            <div class="hd" style="border-bottom-color:rgba(255,255,255,.08)">
              <h2>üìä Today‚Äôs Score</h2>
              <span class="pill"><b id="bestNum">0</b> best streak</span>
            </div>
            <div class="bd">
              <div class="row" style="justify-content:space-between">
                <span class="pill">Served trays: <b id="servedNum">0</b></span>
                <span class="pill">Kind words: <b id="kindNum">0</b></span>
              </div>
              <div class="hint" style="margin-top:10px">
                Pro tip: the ‚Äútiny tip‚Äù strip is secretly helping you become a legendary helper. ü¶∏‚Äç‚ôÄÔ∏èü¶∏‚Äç‚ôÇÔ∏è
              </div>
            </div>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <!-- Modal -->
  <div class="backdrop" id="backdrop" role="dialog" aria-modal="true">
    <div class="modal" id="modal">
      <div class="mh">
        <b id="modalTitle">Menu</b>
        <button class="x" id="modalClose">Close</button>
      </div>
      <div class="mb" id="modalBody"></div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast">
    <div class="tEmoji" id="toastEmoji">‚ú®</div>
    <div class="tTxt" id="toastText"><b>Nice!</b> You earned a star.</div>
  </div>

<script>
(() => {
  // --- Emoji set (from user) ---
  const EMOJIS = ["ü•û","üßá","üç≥","ü•ì","ü•ê","üçû","ü•Ø","üßà","üçØ","üçì","üçå","‚òïÔ∏è","ü´ñ","ü•õ","üßÉ","üçä","üçá"];

  // Categorize for the "Yummy Meter" (simple + kid-friendly)
  const CATEGORY = {
    main: new Set(["ü•û","üßá","üç≥","ü•ì","ü•ê","üçû","ü•Ø"]),
    addOn: new Set(["üßà","üçØ"]),
    fruit: new Set(["üçì","üçå","üçä","üçá"]),
    drink: new Set(["‚òïÔ∏è","ü´ñ","ü•õ","üßÉ"])
  };

  // --- State ---
  const state = {
    traySlots: 6,
    tray: Array(6).fill(null).map(()=>({ emoji:"", qty:0 })),
    selectedSlot: 0,
    tapMode: "tap", // tap | swap
    stars: 0,
    served: 0,
    kindWords: 0,
    bestStreak: 0,
    streak: 0,
    difficulty: "easy", // easy | normal | spicy
    timerOn: false,
    timerSeconds: 0,
    timerLeft: 0,

    // customization
    kidName: "Chef",
    kidEmoji: "üßá",
    themeGlow: 0.18, // 0..0.35
    title: "Breakfast Buddy",
  };

  // --- Tiny tips (the not-obvious ‚Äúads‚Äù) ---
  const ADS = [
    {
      title:"Tiny Tip",
      text:"Try saying ‚Äúplease‚Äù and ‚Äúthank you‚Äù today.",
      kind:true,
      action: { type:"affirm", emoji:"‚ú®", message:"Manners are like magic words. You just cast a kindness spell!" }
    },
    {
      title:"Quick Quiz",
      text:"If you spill juice, what‚Äôs the best first move?",
      kind:true,
      action: { type:"quiz", q:"If you spill juice, what‚Äôs the best first move?",
        options:["Hide it üò¨","Tell an adult + grab a towel üßª","Blame someone else üôÉ"],
        correct:1,
        ok:"Yep! Honest + helpful = hero mode.",
        nope:"Close! Try ‚Äútell an adult + grab a towel.‚Äù"
      }
    },
    {
      title:"Mini Mission",
      text:"Pick one tiny helpful thing you can do in 30 seconds.",
      kind:true,
      action: { type:"picker", prompt:"Pick a tiny helpful thing:",
        options:["Put one dish in the sink üçΩÔ∏è","Throw away one wrapper üßÉ","Ask: ‚ÄúNeed help?‚Äù üíõ","Tidy 3 toys üß∏"],
        ok:"Nice choice! Tiny helpful things add up."
      }
    },
    {
      title:"Fun Fact",
      text:"Helpers notice needs before being asked. That‚Äôs a superpower.",
      kind:true,
      action: { type:"affirm", emoji:"ü¶∏‚Äç‚ôÇÔ∏è", message:"Noticing what needs doing is a real-life superpower." }
    },
    {
      title:"Quick Quiz",
      text:"When someone is talking, what do you do?",
      kind:true,
      action: { type:"quiz", q:"When someone is talking, what do you do?",
        options:["Interrupt üö®","Listen + wait your turn üëÇ","Walk away mid-sentence üö∂‚Äç‚û°Ô∏è"],
        correct:1,
        ok:"Yes! Listening shows respect.",
        nope:"Try ‚ÄúListen + wait your turn.‚Äù"
      }
    }
  ];

  // --- Challenge recipes (silly mini puzzles) ---
  const CHALLENGES = [
    {
      name:"Pancake Party",
      goal:"Make a tray with 1 main + 1 fruit + 1 add-on.",
      require:{ main:1, fruit:1, addOn:1, drink:0 }
    },
    {
      name:"Cozy Caf√©",
      goal:"Make a tray with 1 main + 1 drink (and anything else).",
      require:{ main:1, fruit:0, addOn:0, drink:1 }
    },
    {
      name:"Rainbow Fruits",
      goal:"Add at least 2 different fruits on the tray.",
      require:{ main:0, fruit:2, addOn:0, drink:0 }
    }
  ];

  // --- DOM ---
  const $ = (id) => document.getElementById(id);

  const trayEl = $("tray");
  const pantryEl = $("pantry");

  const slotLabel = $("slotLabel");
  const modeLabel = $("modeLabel");
  const starsNum = $("starsNum");
  const servedNum = $("servedNum");
  const kindNum = $("kindNum");
  const bestNum = $("bestNum");

  const kidNameEl = $("kidName");
  const kidEmojiEl = $("kidEmoji");
  const diffLabel = $("diffLabel");
  const timerLabel = $("timerLabel");

  const yummyNum = $("yummyNum");
  const yummyBar = $("yummyBar");
  const yummyHint = $("yummyHint");

  const adTitle = $("adTitle");
  const adText = $("adText");
  const adBtn = $("adBtn");

  const backdrop = $("backdrop");
  const modalTitle = $("modalTitle");
  const modalBody = $("modalBody");
  const modalClose = $("modalClose");

  const toast = $("toast");
  const toastEmoji = $("toastEmoji");
  const toastText = $("toastText");

  // --- Helpers ---
  function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }

  function countsByCategory(){
    const set = { main:0, fruit:0, addOn:0, drink:0, total:0, distinct:new Set() };
    for (const s of state.tray){
      if (!s.emoji || s.qty<=0) continue;
      set.total += s.qty;
      set.distinct.add(s.emoji);
      if (CATEGORY.main.has(s.emoji)) set.main += 1;
      else if (CATEGORY.fruit.has(s.emoji)) set.fruit += 1;
      else if (CATEGORY.addOn.has(s.emoji)) set.addOn += 1;
      else if (CATEGORY.drink.has(s.emoji)) set.drink += 1;
    }
    return set;
  }

  function computeYummy(){
    // Simple scoring: encourage variety, fruit, drink, not too many mains
    const c = countsByCategory();
    let score = 40;

    // variety bonus
    score += Math.min(20, c.distinct.size * 4);

    // fruit + drink are great
    score += c.fruit * 8;
    score += c.drink * 6;

    // add-ons are fun, but not everything
    score += c.addOn * 4;

    // too many mains makes it heavy
    score -= Math.max(0, (c.main - 2)) * 6;

    // empty tray should not be high
    if (c.total === 0) score = 20;

    // difficulty tweaks
    if (state.difficulty === "normal") score -= 2;
    if (state.difficulty === "spicy") score -= 4;

    return clamp(Math.round(score), 0, 100);
  }

  function showToast(emoji, htmlText){
    toastEmoji.textContent = emoji;
    toastText.innerHTML = htmlText;
    toast.classList.add("show");
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=>toast.classList.remove("show"), 2200);
  }

  function openModal(title, contentNode){
    modalTitle.textContent = title;
    modalBody.innerHTML = "";
    modalBody.appendChild(contentNode);
    backdrop.classList.add("show");
  }
  function closeModal(){ backdrop.classList.remove("show"); }

  function makeEl(tag, attrs={}, children=[]){
    const el = document.createElement(tag);
    for (const [k,v] of Object.entries(attrs)){
      if (k === "class") el.className = v;
      else if (k === "html") el.innerHTML = v;
      else if (k.startsWith("on") && typeof v === "function") el.addEventListener(k.slice(2), v);
      else el.setAttribute(k, v);
    }
    for (const ch of children) el.appendChild(ch);
    return el;
  }

  function setThemeGlow(x){
    // Uses CSS variable approach by slightly changing the background gradient intensity.
    // We'll update a custom CSS var by altering a root variable via inline style.
    state.themeGlow = clamp(x, 0, 0.35);
    document.documentElement.style.setProperty("--glow", String(state.themeGlow));
  }

  function applyTitle(){
    $("appTitle").textContent = state.title;
    document.title = state.title + " ü•û";
  }

  // --- Render ---
  function renderPantry(){
    pantryEl.innerHTML = "";
    EMOJIS.forEach((e) => {
      const chip = document.createElement("div");
      chip.className = "chip";
      chip.textContent = e;
      chip.title = "Tap to place";
      chip.addEventListener("click", () => onPickEmoji(e));
      pantryEl.appendChild(chip);
    });
  }

  function renderTray(){
    trayEl.innerHTML = "";
    state.tray.forEach((s, idx) => {
      const slot = document.createElement("div");
      slot.className = "slot";
      if (idx === state.selectedSlot) slot.style.outline = "2px solid rgba(255,223,110,.55)";

      const top = document.createElement("div");
      top.className = "top";

      const label = document.createElement("div");
      label.className = "label";
      label.textContent = "Slot " + (idx+1);

      const pickBtn = document.createElement("button");
      pickBtn.className = "smallBtn";
      pickBtn.textContent = (idx === state.selectedSlot) ? "Selected ‚úÖ" : "Select";
      pickBtn.addEventListener("click", () => {
        state.selectedSlot = idx;
        renderAll();
      });

      top.appendChild(label);
      top.appendChild(pickBtn);

      const emojiBox = document.createElement("div");
      emojiBox.className = "emoji";
      emojiBox.textContent = (s.emoji && s.qty>0) ? s.emoji : "‚ûï";
      emojiBox.addEventListener("click", () => {
        state.selectedSlot = idx;
        renderAll();
        showToast("üëÜ", "<b>Selected</b> Slot " + (idx+1) + ". Now pick an emoji!");
      });

      const controls = document.createElement("div");
      controls.className = "controls";

      const counter = document.createElement("div");
      counter.className = "counter";
      const minus = document.createElement("button");
      minus.textContent = "‚Äì";
      minus.addEventListener("click", () => {
        if (state.tray[idx].qty > 0) state.tray[idx].qty -= 1;
        if (state.tray[idx].qty <= 0) { state.tray[idx].qty = 0; state.tray[idx].emoji=""; }
        renderAll();
      });
      const n = document.createElement("div");
      n.className = "n";
      n.textContent = String(s.qty || 0);
      const plus = document.createElement("button");
      plus.textContent = "+";
      plus.addEventListener("click", () => {
        if (!state.tray[idx].emoji){
          showToast("üß∫", "<b>Pick an emoji</b> from the pantry first.");
          return;
        }
        state.tray[idx].qty = clamp((state.tray[idx].qty || 0) + 1, 0, 9);
        renderAll();
      });
      counter.appendChild(minus);
      counter.appendChild(n);
      counter.appendChild(plus);

      const clearBtn = document.createElement("button");
      clearBtn.className = "smallBtn";
      clearBtn.textContent = "Clear";
      clearBtn.addEventListener("click", () => {
        state.tray[idx] = { emoji:"", qty:0 };
        renderAll();
      });

      controls.appendChild(counter);
      controls.appendChild(clearBtn);

      const stamp = document.createElement("div");
      stamp.className = "stamp";

      slot.appendChild(top);
      slot.appendChild(emojiBox);
      slot.appendChild(controls);
      slot.appendChild(stamp);
      trayEl.appendChild(slot);
    });

    slotLabel.textContent = String(state.selectedSlot + 1);
  }

  function renderStatsAndMeter(){
    starsNum.textContent = String(state.stars);
    servedNum.textContent = String(state.served);
    kindNum.textContent = String(state.kindWords);
    bestNum.textContent = String(state.bestStreak);

    kidNameEl.textContent = state.kidName;
    kidEmojiEl.textContent = state.kidEmoji;

    diffLabel.textContent = (state.difficulty === "easy") ? "Easy" : (state.difficulty === "normal") ? "Normal" : "Spicy";
    timerLabel.textContent = state.timerOn ? (state.timerLeft + "s") : "Off";

    const y = computeYummy();
    yummyNum.textContent = String(y);
    yummyBar.style.width = y + "%";

    // Friendly hint based on tray content
    const c = countsByCategory();
    let hint = "Balance your tray: add a fruit üçìüçåüçäüçá or a drink ü•õüßÉ‚òïÔ∏èü´ñ";
    if (c.total === 0) hint = "Start by placing something yummy into Slot " + (state.selectedSlot+1) + " ‚ûï";
    else if (c.fruit === 0 && c.total > 0) hint = "Try adding a fruit for a happy-tummy boost üçìüçåüçäüçá";
    else if (c.drink === 0 && c.total > 0) hint = "A drink makes it cozy ‚òïÔ∏èü´ñü•õüßÉ";
    else if (y >= 80) hint = "Legendary tray! Serve it! üçΩÔ∏è‚ú®";
    yummyHint.textContent = hint;
  }

  function renderModeLabels(){
    modeLabel.textContent = (state.tapMode === "tap") ? "Tap-to-Place" : "Swap Mode";
  }

  function renderAdStrip(){
    const ad = pickAd();
    adTitle.textContent = ad.title;
    adText.textContent = ad.text;
    adBtn.textContent = (ad.action.type === "quiz") ? "Answer" : (ad.action.type === "picker") ? "Pick" : "Okay";
    adBtn.onclick = () => runAd(ad);
  }

  function renderAll(){
    applyTitle();
    renderModeLabels();
    renderTray();
    renderStatsAndMeter();
    // ad strip stays as-is until rotated, but we keep button wired
  }

  // --- Pantry interaction ---
  function onPickEmoji(emoji){
    const idx = state.selectedSlot;
    const slot = state.tray[idx];

    if (state.tapMode === "tap"){
      state.tray[idx] = { emoji, qty: Math.max(1, slot.qty || 0) };
      showToast(emoji, "<b>Placed!</b> Now adjust + / ‚Äì if you want.");
    } else {
      // swap mode: swap emoji between selected slot and first slot containing same emoji? or just cycle
      // Simple: swap with previous slot (wrap)
      const prev = (idx + state.tray.length - 1) % state.tray.length;
      const tmp = state.tray[prev];
      state.tray[prev] = state.tray[idx];
      state.tray[idx] = tmp;
      // then set current slot emoji
      state.tray[idx].emoji = emoji;
      if (state.tray[idx].qty <= 0) state.tray[idx].qty = 1;
      showToast("üîÅ", "<b>Swapped!</b> And set Slot " + (idx+1) + " to " + emoji);
    }
    renderAll();
  }

  // --- Ad system ---
  let adIndex = 0;
  function pickAd(){
    // rotate but keep stable for a bit
    const ad = ADS[adIndex % ADS.length];
    return ad;
  }
  function nextAd(){
    adIndex = (adIndex + 1) % ADS.length;
    renderAdStrip();
  }

  function awardStar(reason="Kindness"){
    state.stars += 1;
    state.kindWords += 1;
    showToast("‚ú®", "<b>Star earned!</b> " + reason);
    // streak tracking for best streak (simple)
    state.streak += 1;
    state.bestStreak = Math.max(state.bestStreak, state.streak);
  }

  function runAd(ad){
    // Each ad leads to a tiny modal "activity"
    if (ad.action.type === "affirm"){
      const box = makeEl("div", {}, [
        makeEl("div", { class:"pill", html:`<b>${ad.action.emoji}</b> ${ad.title}` }),
        makeEl("div", { class:"field" }, [
          makeEl("label", { html:"Try reading this out loud:" }),
          makeEl("div", { class:"hint", html:`<span class="ok">‚Äú${ad.action.message}‚Äù</span>` }),
        ]),
        makeEl("div", { class:"row", style:"justify-content:flex-end" }, [
          makeEl("button", { class:"primary", onclick: () => {
            awardStar("You practiced a kind thought.");
            closeModal(); nextAd();
          }}, [document.createTextNode("I tried it ‚úÖ")]),
          makeEl("button", { onclick: () => { closeModal(); nextAd(); }}, [document.createTextNode("Maybe later")])
        ])
      ]);
      openModal("Tiny Tip", box);
      return;
    }

    if (ad.action.type === "picker"){
      const picked = { idx: -1 };
      const list = makeEl("div", { class:"seg" },
        ad.action.options.map((opt,i)=>{
          const b = makeEl("button", { onclick: () => {
            picked.idx = i;
            [...list.querySelectorAll("button")].forEach(btn=>btn.classList.remove("on"));
            b.classList.add("on");
          }}, [document.createTextNode(opt)]);
          return b;
        })
      );

      const box = makeEl("div", {}, [
        makeEl("div", { class:"pill", html:`<b>üß†</b> ${ad.title}` }),
        makeEl("div", { class:"field" }, [
          makeEl("label", { html: ad.action.prompt }),
          list,
          makeEl("div", { class:"hint", html:`Pick one and then do it in real life if you can.` })
        ]),
        makeEl("div", { class:"row", style:"justify-content:flex-end" }, [
          makeEl("button", { class:"primary", onclick: () => {
            if (picked.idx < 0){
              showToast("üëÄ", "<b>Pick one</b> first.");
              return;
            }
            awardStar(ad.action.ok);
            closeModal(); nextAd();
          }}, [document.createTextNode("Done! ‚úÖ")]),
          makeEl("button", { onclick: () => { closeModal(); nextAd(); }}, [document.createTextNode("Close")])
        ])
      ]);
      openModal("Mini Mission", box);
      return;
    }

    if (ad.action.type === "quiz"){
      const chosen = { idx: -1 };
      const list = makeEl("div", { class:"seg" },
        ad.action.options.map((opt,i)=>{
          const b = makeEl("button", { onclick: () => {
            chosen.idx = i;
            [...list.querySelectorAll("button")].forEach(btn=>btn.classList.remove("on"));
            b.classList.add("on");
          }}, [document.createTextNode(opt)]);
          return b;
        })
      );

      const result = makeEl("div", { class:"hint", html:"Pick an answer!" });

      const box = makeEl("div", {}, [
        makeEl("div", { class:"pill", html:`<b>üß©</b> ${ad.title}` }),
        makeEl("div", { class:"field" }, [
          makeEl("label", { html: ad.action.q }),
          list,
          result
        ]),
        makeEl("div", { class:"row", style:"justify-content:flex-end" }, [
          makeEl("button", { class:"primary", onclick: () => {
            if (chosen.idx < 0){
              showToast("üëÄ", "<b>Pick an answer</b> first.");
              return;
            }
            const ok = (chosen.idx === ad.action.correct);
            result.innerHTML = ok ? `<span class="ok">${ad.action.ok}</span>` : `<span class="bad">${ad.action.nope}</span>`;
            if (ok) awardStar("Good choice!");
            else {
              // gentle: no streak penalty, but reset streak softly
              state.streak = 0;
              showToast("üí°", "<b>Learning moment!</b> Try again next time.");
            }
            renderAll();
            // auto rotate ad after a short delay
            setTimeout(()=>{ closeModal(); nextAd(); }, 900);
          }}, [document.createTextNode("Check ‚úÖ")]),
          makeEl("button", { onclick: () => { closeModal(); nextAd(); }}, [document.createTextNode("Close")])
        ])
      ]);
      openModal("Quick Quiz", box);
      return;
    }
  }

  // --- Serve logic ---
  function serveTray(){
    const c = countsByCategory();
    if (c.total === 0){
      showToast("üß∫", "<b>Empty tray!</b> Add at least one thing first.");
      return;
    }

    const yummy = computeYummy();
    state.served += 1;

    // Stars: reward balance and variety
    let starsEarned = 0;
    if (c.distinct.size >= 3) starsEarned += 1;
    if (c.fruit >= 1) starsEarned += 1;
    if (c.drink >= 1) starsEarned += 1;
    if (yummy >= 80) starsEarned += 1;
    if (state.difficulty === "spicy") starsEarned += 1;

    // If timer is on, bonus for finishing in time
    if (state.timerOn && state.timerLeft > 0) starsEarned += 1;

    starsEarned = clamp(starsEarned, 1, 5);
    state.stars += starsEarned;
    state.kindWords += 1;
    state.bestStreak = Math.max(state.bestStreak, state.bestStreak);

    showToast("üçΩÔ∏è", `<b>Served!</b> You earned <b>${starsEarned}</b> star${starsEarned===1?"":"s"} ‚ú®`);

    // After serving, gently reset tray
    newTray(false);

    // rotate ad
    nextAd();
    renderAll();
  }

  function newTray(loud=true){
    state.tray = Array(state.traySlots).fill(null).map(()=>({ emoji:"", qty:0 }));
    state.selectedSlot = 0;
    if (state.timerOn){
      state.timerLeft = state.timerSeconds;
    }
    if (loud) showToast("üÜï", "<b>New tray!</b> Pick something yummy.");
  }

  // --- Mini Challenge ---
  function openChallenge(){
    const pick = CHALLENGES[Math.floor(Math.random()*CHALLENGES.length)];
    const req = pick.require;

    const box = makeEl("div", {}, [
      makeEl("div", { class:"pill", html:`<b>üéØ</b> ${pick.name}` }),
      makeEl("div", { class:"field" }, [
        makeEl("label", { html:"Goal" }),
        makeEl("div", { class:"hint", html:`<span class="ok">${pick.goal}</span>` }),
        makeEl("div", { class:"hint", html:`Tip: mains = ü•ûüßáüç≥ü•ìü•êüçûü•Ø ¬∑ fruits = üçìüçåüçäüçá ¬∑ add-ons = üßàüçØ ¬∑ drinks = ‚òïÔ∏èü´ñü•õüßÉ` }),
      ]),
      makeEl("div", { class:"row", style:"justify-content:space-between;align-items:center" }, [
        makeEl("button", { onclick: () => { closeModal(); }}, [document.createTextNode("Close")]),
        makeEl("button", { class:"primary", onclick: () => {
          const c = countsByCategory();
          const ok = (c.main >= req.main) && (c.fruit >= req.fruit) && (c.addOn >= req.addOn) && (c.drink >= req.drink);
          if (ok){
            awardStar("Challenge completed!");
            awardStar("Double bonus!");
            showToast("üèÜ", "<b>Challenge WIN!</b> You‚Äôre a breakfast legend.");
            closeModal();
            nextAd();
          } else {
            state.streak = 0;
            showToast("üß©", "<b>Not yet</b> ‚Äî keep building your tray!");
          }
          renderAll();
        }}, [document.createTextNode("Check My Tray ‚úÖ")]),
      ])
    ]);

    openModal("Mini Challenge", box);
  }

  // --- Customize ---
  function openCustomize(){
    const box = makeEl("div", {}, []);

    // Name
    const fName = makeEl("div", { class:"field" }, [
      makeEl("label", { html:"Chef Name" }),
      (() => {
        const inp = document.createElement("input");
        inp.type = "text";
        inp.value = state.kidName;
        inp.placeholder = "Chef Rosie / Chef Dom / etc";
        inp.addEventListener("input", () => {
          state.kidName = inp.value.slice(0, 18) || "Chef";
          renderAll();
        });
        return inp;
      })(),
      makeEl("div", { class:"hint", html:"Pick a fun name! (Short is best.)" })
    ]);

    // Avatar picker
    const fAvatar = makeEl("div", { class:"field" }, [
      makeEl("label", { html:"Chef Emoji" }),
      (() => {
        const seg = makeEl("div", { class:"seg" }, []);
        const options = ["ü•û","üßá","üçì","üçå","‚òïÔ∏è","ü´ñ","ü•õ","üßÉ"];
        options.forEach(e=>{
          const b = makeEl("button", { }, [document.createTextNode(e)]);
          if (state.kidEmoji === e) b.classList.add("on");
          b.addEventListener("click", ()=>{
            state.kidEmoji = e;
            [...seg.querySelectorAll("button")].forEach(x=>x.classList.remove("on"));
            b.classList.add("on");
            renderAll();
          });
          seg.appendChild(b);
        });
        return seg;
      })(),
      makeEl("div", { class:"hint", html:"This is just for fun. Pick your vibe." })
    ]);

    // Difficulty
    const fDiff = makeEl("div", { class:"field" }, [
      makeEl("label", { html:"Difficulty" }),
      (() => {
        const seg = makeEl("div", { class:"seg" }, []);
        const opts = [
          {k:"easy", t:"Easy üòä"},
          {k:"normal", t:"Normal üòé"},
          {k:"spicy", t:"Spicy üî•"},
        ];
        opts.forEach(o=>{
          const b = makeEl("button", {}, [document.createTextNode(o.t)]);
          if (state.difficulty === o.k) b.classList.add("on");
          b.addEventListener("click", ()=>{
            state.difficulty = o.k;
            [...seg.querySelectorAll("button")].forEach(x=>x.classList.remove("on"));
            b.classList.add("on");
            renderAll();
          });
          seg.appendChild(b);
        });
        return seg;
      })(),
      makeEl("div", { class:"hint", html:"Spicy gives extra stars when you serve." })
    ]);

    // Timer
    const fTimer = makeEl("div", { class:"field" }, [
      makeEl("label", { html:"Timer (optional)" }),
      (() => {
        const seg = makeEl("div", { class:"seg" }, []);
        const btnOff = makeEl("button", {}, [document.createTextNode("Off")]);
        const btn30 = makeEl("button", {}, [document.createTextNode("30s")]);
        const btn45 = makeEl("button", {}, [document.createTextNode("45s")]);
        const btn60 = makeEl("button", {}, [document.createTextNode("60s")]);

        function setTimer(on, secs){
          state.timerOn = on;
          state.timerSeconds = secs || 0;
          state.timerLeft = secs || 0;
          [...seg.querySelectorAll("button")].forEach(x=>x.classList.remove("on"));
          const active = !on ? btnOff : (secs===30?btn30:secs===45?btn45:btn60);
          active.classList.add("on");
          renderAll();
        }

        btnOff.addEventListener("click", ()=>setTimer(false,0));
        btn30.addEventListener("click", ()=>setTimer(true,30));
        btn45.addEventListener("click", ()=>setTimer(true,45));
        btn60.addEventListener("click", ()=>setTimer(true,60));

        seg.appendChild(btnOff); seg.appendChild(btn30); seg.appendChild(btn45); seg.appendChild(btn60);

        // init state
        (state.timerOn ? (state.timerSeconds===30?btn30:state.timerSeconds===45?btn45:btn60) : btnOff).classList.add("on");
        return seg;
      })(),
      makeEl("div", { class:"hint", html:"If timer is on, you get a bonus star for serving before it hits 0." })
    ]);

    // Place mode
    const fMode = makeEl("div", { class:"field" }, [
      makeEl("label", { html:"Placement Mode" }),
      (() => {
        const seg = makeEl("div", { class:"seg" }, []);
        const b1 = makeEl("button", {}, [document.createTextNode("Tap-to-Place üëÜ")]);
        const b2 = makeEl("button", {}, [document.createTextNode("Swap Mode üîÅ")]);
        function set(m){
          state.tapMode = m;
          b1.classList.toggle("on", m==="tap");
          b2.classList.toggle("on", m==="swap");
          renderAll();
        }
        b1.addEventListener("click", ()=>set("tap"));
        b2.addEventListener("click", ()=>set("swap"));
        set(state.tapMode);
        seg.appendChild(b1); seg.appendChild(b2);
        return seg;
      })(),
      makeEl("div", { class:"hint", html:"Swap mode is silly: it swaps with the previous slot, then places." })
    ]);

    // App title
    const fTitle = makeEl("div", { class:"field" }, [
      makeEl("label", { html:"App Title" }),
      (() => {
        const inp = document.createElement("input");
        inp.type = "text";
        inp.value = state.title;
        inp.addEventListener("input", ()=>{
          state.title = inp.value.slice(0, 24) || "Breakfast Buddy";
          renderAll();
        });
        return inp;
      })(),
      makeEl("div", { class:"hint", html:"Example: ‚ÄúRosie‚Äôs Breakfast Lab‚Äù" })
    ]);

    // Buttons
    const footer = makeEl("div", { class:"row", style:"justify-content:flex-end" }, [
      makeEl("button", { class:"warn", onclick: () => {
        // reset stats (safe + kid-friendly)
        state.stars = 0; state.served = 0; state.kindWords = 0;
        state.bestStreak = 0; state.streak = 0;
        showToast("üßΩ", "<b>Clean slate!</b> Score reset.");
        renderAll();
      }}, [document.createTextNode("Reset Score üßΩ")]),
      makeEl("button", { class:"primary", onclick: () => { closeModal(); }}, [document.createTextNode("Done ‚úÖ")]),
    ]);

    box.appendChild(fName);
    box.appendChild(fAvatar);
    box.appendChild(fDiff);
    box.appendChild(fTimer);
    box.appendChild(fMode);
    box.appendChild(fTitle);
    box.appendChild(footer);

    openModal("Customize", box);
  }

  // --- Timer tick ---
  function tick(){
    if (!state.timerOn) return;
    if (state.timerLeft <= 0) return;

    state.timerLeft -= 1;
    if (state.timerLeft === 10) showToast("‚è≥", "<b>10 seconds!</b> You got this.");
    if (state.timerLeft === 0){
      showToast("üïí", "<b>Time!</b> No worries ‚Äî you can still serve.");
      // soft streak reset
      state.streak = 0;
    }
    renderStatsAndMeter();
  }

  // --- Wire up buttons ---
  $("btnNew").addEventListener("click", ()=>newTray(true));
  $("btnServe").addEventListener("click", serveTray);
  $("btnCustomize").addEventListener("click", openCustomize);
  $("btnChallenge").addEventListener("click", openChallenge);

  modalClose.addEventListener("click", closeModal);
  backdrop.addEventListener("click", (e)=>{ if (e.target === backdrop) closeModal(); });

  // --- Init ---
  renderPantry();
  renderAdStrip();
  newTray(false);
  renderAll();

  // Rotate tiny tips every ~20s (gentle)
  setInterval(()=>{ nextAd(); }, 20000);

  // 1-second tick for timer
  setInterval(tick, 1000);

  // Tiny onboarding nudge
  setTimeout(()=>showToast("ü•û", "<b>Tap a pantry emoji</b> to place it in the selected slot."), 600);
})();
</script>
</body>
</html>